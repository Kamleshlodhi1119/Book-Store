<app-user-header></app-user-header>

<div class="details-page-wrapper">
  <section class="details-container" *ngIf="!loading && book">

    <div class="media-column">
      <div class="sticky-wrapper">
        <img class="main-book-img" [src]="book.imageUrl ? imageApi + book.imageUrl : 'assets/book-placeholder.png'"
          [alt]="book.title" />

        <div class="quick-meta">
          <div class="avg-badge">
            <span class="star-icon">‚≠ê</span>
            <span class="rating-val">{{ book.averageRating || 0 }}</span>
            <span class="total-reviews" *ngFor="let r of bookRatings">({{ r?.length || 0 }} reviews)</span>
          </div>
        </div>
      </div>
    </div>

    <div class="content-column">
      <header class="book-header">
        <div class="tag-row">
          <span class="stock-tag" [class.out]="book.stockQuantity === 0">
            {{ book.stockQuantity > 0 ? 'In Stock' : 'Out of Stock' }}
          </span>
          <span class="isbn-tag">ISBN: {{book.isbn}}</span>
        </div>
        <h1 class="book-title">{{ book.title }}</h1>
        <p class="book-author">By <span>{{ book.authorName }}</span></p>
      </header>

      <div class="price-section">
        <span class="currency">‚Çπ</span>
        <span class="amount">{{ book.price }}</span>
      </div>

      <p class="description-text">{{ book.description }}</p>

      <div class="action-buttons">
        <button class="buy-btn" (click)="addToCart()" [disabled]="book.stockQuantity === 0">
          <i class="shopping-cart-icon"></i> Add to Cart
        </button>
        <button class="wish-btn" (click)="addToWishlist()">
          ‚ô• Add to Wishlist
        </button>
      </div>

      <hr class="divider">

      <section class="rating-form-section" *ngIf="isLoggedIn">
        <h3>Share your thoughts</h3>
        <div class="form-group">
          <label>How would you rate it?</label>
          <div class="star-rating-input">
            <select [(ngModel)]="rating" class="modern-select">
              <option [value]="0">Select Stars</option>
              <option *ngFor="let r of [5,4,3,2,1]" [value]="r">{{r}} Stars</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <textarea [(ngModel)]="comment" placeholder="Write your review here..."></textarea>
        </div>
        <button class="submit-review-btn" (click)="submitRating()">
          <i class="fa-solid fa-paper-plane"></i>
          Submit Review
        </button>

      </section>

      <section class="user-reviews-list">
        <h3>Community Reviews ({{ bookRatings.length }})</h3>

        <div *ngIf="bookRatings.length === 0" class="no-reviews">
          Be the first to review this book!
        </div>

        <div class="review-card" *ngFor="let r of bookRatings">
          <div class="review-header">
            <span class="user-avatar">{{ r.username.charAt(0).toUpperCase() }}</span>
            <div class="user-meta">
              <span class="user-name">
                {{ r.username }}
                <b *ngIf="isMyReview(r.username)" style="color: #27ae60;"> (You)</b>
              </span>
              <span class="review-stars">‚≠ê {{ r.rating }}/5</span>
            </div>

            <button *ngIf="isMyReview(r.username)" (click)="deleteMyReview()" class="delete-review-btn"
              title="Delete my review">
              üóëÔ∏è
            </button>
          </div>
          <p class="review-body">{{ r.comment }}</p>
        </div>
      </section>
    </div>
  </section>
</div>